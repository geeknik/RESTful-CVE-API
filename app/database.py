import csv
import os
import sqlite3

DATABASE = 'cve_db.db'

def get_db_connection():
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

def import_data(csv_file):
    #getting the path of the root directory
    script_dir = os.path.dirname(os.path.abspath(__file__))
    
    #getting the absolute path to the csv
    csv_path = os.path.join(script_dir, csv_file)

    #connecting to sqlite database
    conn = get_db_connection()
    cursor = conn.cursor()

    #creating the table if not already exist
    cursor.execute('''CREATE TABLE IF NOT EXISTS cve_database (
                        id INTEGER PRIMARY KEY,
                        cve_id TEXT,
                        severity TEXT,
                        cvss TEXT,
                        affected_packages TEXT,
                        description TEXT,
                        cwe_id TEXT
                    )''')

    #reading the csv file to insert into table
    with open(csv_path, 'r') as file:
        csv_reader = csv.reader(file)
        next(csv_reader)  #skipping header
        for row in csv_reader:
            #checking if the entry already exist in table
            cursor.execute("SELECT id FROM cve_database WHERE cve_id=?", (row[0],))
            existing_row = cursor.fetchone()
            if existing_row is None:
                #inserting if entry does not exist already
                cursor.execute('''INSERT INTO cve_database (cve_id, severity, cvss, affected_packages, description, cwe_id)
                                VALUES (?, ?, ?, ?, ?, ?)''', row)
    conn.commit()
    conn.close()

#importing the data
import_data('CVE_DATABASE.csv')
